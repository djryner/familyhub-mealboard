{% extends "base.html" %}

{% block title %}Dashboard - Family Hub{% endblock %}

{% block content %}
<style>
    .meal-row {
        display: flex;
        overflow-x: auto;
        gap: 12px;
    }

    .meal-card {
        flex: 0 0 auto;
        min-width: 160px; /* provide room for weekday + date + title */
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        padding: .5rem .75rem;
        white-space: normal; /* allow wrapping */
        word-break: break-word; /* prevent overflow for long words */
    }

    /* Accessibility / Contrast: previously a light green background with light (inherited) text caused "blank" looking card.
       Switch to outline highlight so we retain dark theme background and high-contrast light text. */
    .meal-card.today {
        outline: 2px solid #28a745;
        outline-offset: 0;
        border-color: #28a745;
        background: inherit; /* keep dark theme */
    }

    .meal-name {
        margin-top: 2px;
        font-weight: 600;
        white-space: normal;
        word-break: break-word;
    }

    /* So muted meta line is still readable on dark background */
    .meal-card .text-muted { color: #9ca3af !important; }

    /* Live clock positioning (dashboard only) */
    .section-header { position: relative; }
    .live-clock {
        position: absolute;
        top: 0;
        right: 0;
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: .5px;
        padding: .25rem .6rem;
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: .5rem;
        background: rgba(0,0,0,0.35);
        backdrop-filter: blur(3px);
        -webkit-backdrop-filter: blur(3px);
        min-width: 140px;
        text-align: center;
        color: #f8f9fa; /* Ensure readable contrast */
    }

    .chore-card {
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        padding: .55rem .75rem;
        margin-bottom: .6rem;
        display: flex;
        align-items: flex-start;
        gap: .75rem;
    }

    .chore-card .chore-info {
        flex: 1 1 auto;
        min-width: 0;
    }

    .chore-card.completed {
        opacity: .55;
        text-decoration: line-through;
    }

    /* Compact complete button */
    .chore-complete-btn {
        flex: 0 0 auto;
        width: auto;
        margin: 0;
        padding: .25rem .55rem;
        font-size: .7rem;
        line-height: 1.1;
        font-weight: 600;
        white-space: nowrap;
    }
    .chore-complete-btn:disabled {
        opacity: .85;
    }

    /* Remove old full-width style (override) */
    .btn-complete {
        width: auto !important;
        margin-top: 0 !important;
    }
</style>

<div class="section-header">
    <h1>Family Dashboard</h1>
    <div id="liveClock" class="live-clock" aria-label="Current date and time"></div>
</div>
<script>
    // Live clock (runs only on dashboard)
    (function startLiveClock() {
        const el = document.getElementById('liveClock');
        if (!el) return;
        function fmt() {
            const now = new Date();
            // Example: Sat Aug 9 11:53 AM
            const opts = { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
            // Remove the comma some locales insert after weekday
            let text = now.toLocaleString(undefined, opts).replace(',', '');
            el.textContent = text;
            el.setAttribute('aria-label', text);
            // Schedule next update exactly at next minute boundary
            const msToNextMinute = 60000 - (now.getSeconds() * 1000 + now.getMilliseconds());
            setTimeout(fmt, msToNextMinute);
        }
        fmt();
    })();
</script>

<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">Meals This Week</h4>
    </div>
    <div class="card-body">
        {% if meals %}
        <div class="meal-row">
            {% for meal in meals[:7] %}
            <div class="meal-card {% if meal.date == today %}today{% endif %}" aria-label="{{ meal.date.strftime('%A %m/%d') }}: {{ meal.title }}">
                <div class="text-muted small">{{ meal.date.strftime('%a') }} • {{ meal.date.strftime('%m/%d') }}</div>
                <div class="meal-name">{{ meal.title }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">No meals planned yet.</p>
        {% endif %}
    </div>
</div>

{% if points_enabled %}
<div class="card p-3 mb-4">
  <h5 class="mb-3">This Week’s Leaderboard</h5>
  <ol class="mb-0">
    {% for row in leaderboard[:5] %}
      <li class="d-flex justify-content-between">
        <span>{{ row.user_name }}</span>
        <strong>{{ row.pts }}</strong>
      </li>
    {% else %}
      <div class="text-muted">No points yet—get started!</div>
    {% endfor %}
  </ol>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h4 class="mb-0">Today's Chores</h4>
    </div>
    <div class="card-body">
    {% set any_today = namespace(value=false) %}
    {% for chore in chores %}
        {% if chore.due_date and chore.due_date == today %}
            {% set any_today.value = true %}
            <div class="chore-card {% if chore.completed %}completed{% endif %}" id="chore-{{ chore.id }}">
                <div class="chore-info">
                    <div class="fw-bold text-truncate">{{ chore.title }}</div>
                    <div class="text-muted small">
                        {% if chore.assigned_to %}{{ chore.assigned_to }}{% endif %}
                        <!-- priority display removed -->
                    </div>
                </div>
                <form class="chore-complete-form" action="{{ url_for('complete_chore', chore_id=chore.id) }}" method="post" style="display:inline;">
                    <button
                        class="btn btn-sm btn-outline-success chore-complete-btn btn-complete"
                        data-due="{{ chore.due_date.isoformat() if chore.due_date else '' }}"
                        {% if chore.completed %}disabled{% endif %}
                        aria-label="Mark {{ chore.title }} complete">
                        {% if chore.completed %}Done{% else %}Complete{% endif %}
                    </button>
                </form>
                <form action="{{ url_for('ignore_chore', chore_id=chore.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger chore-complete-btn" {% if chore.completed %}disabled{% endif %}>
                        <i class="fas fa-ban me-1"></i>Ignore
                    </button>
                </form>
            </div>
        {% endif %}
        {% endfor %}
        {% if not any_today.value %}
        <p class="text-muted mb-0">No chores due today.</p>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.chore-complete-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = form.querySelector('.chore-complete-btn');
            if (btn.disabled) return;
            const due = btn.dataset.due;
            fetch(form.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ due_iso: due })
            }).then(resp => {
                if (!resp.ok) throw new Error('Request failed');
                btn.textContent = 'Completed';
                btn.disabled = true;
                btn.closest('.chore-card').classList.add('completed');
            }).catch(err => {
                alert('Sorry, could not complete the chore.');
            });
        });
    });
});
</script>
{% endblock %}