{% extends "base.html" %}

{% block title %}Dashboard - Family Hub{% endblock %}

{% block content %}
<style>
    .meal-row {
        display: flex;
        overflow-x: auto;
        gap: 12px;
    }

    .meal-card {
        flex: 0 0 auto;
        min-width: 160px; /* provide room for weekday + date + title */
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        padding: .5rem .75rem;
        white-space: normal; /* allow wrapping */
        word-break: break-word; /* prevent overflow for long words */
    }

    /* Accessibility / Contrast: previously a light green background with light (inherited) text caused "blank" looking card.
       Switch to outline highlight so we retain dark theme background and high-contrast light text. */
    .meal-card.today {
        outline: 2px solid #28a745;
        outline-offset: 0;
        border-color: #28a745;
        background: inherit; /* keep dark theme */
    }

    .meal-name {
        margin-top: 2px;
        font-weight: 600;
        white-space: normal;
        word-break: break-word;
    }

    /* So muted meta line is still readable on dark background */
    .meal-card .text-muted { color: #9ca3af !important; }

    .chore-card {
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .chore-card.completed {
        opacity: .55;
        text-decoration: line-through;
    }

    .btn-complete {
        width: 100%;
        margin-top: .75rem;
    }
</style>

<div class="section-header">
    <h1>Family Dashboard</h1>
</div>

{# Accept either a date/datetime object or a pre-formatted ISO string #}
{% if today is string %}
    {% set today_iso = today %}
{% elif today.strftime is defined %}
    {% set today_iso = today.strftime('%Y-%m-%d') %}
{% else %}
    {% set today_iso = today|string %}
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">Meals This Week</h4>
    </div>
    <div class="card-body">
        {% if meals %}
        <div class="meal-row">
            {% for meal in meals[:7] %}
            <div class="meal-card {% if meal.date == today %}today{% endif %}" aria-label="{{ meal.date.strftime('%A %m/%d') }}: {{ meal.title }}">
                <div class="text-muted small">{{ meal.date.strftime('%a') }} • {{ meal.date.strftime('%m/%d') }}</div>
                <div class="meal-name">{{ meal.title }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">No meals planned yet.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4 class="mb-0">Today's Chores</h4>
    </div>
    <div class="card-body">
        {% set any_today = namespace(value=false) %}
        {% for chore in chores %}
        {% if chore.due_date %}
        {% if chore.due_date.strftime is defined %}
        {% set due_iso = chore.due_date.strftime('%Y-%m-%d') %}
        {% else %}
        {% set due_iso = chore.due_date[:10] %}
        {% endif %}
        {% else %}
        {% set due_iso = '' %}
        {% endif %}

        {% if due_iso == today_iso %}
        {% set any_today.value = true %}
        <div class="chore-card {% if chore.completed %}completed{% endif %}" id="chore-{{ chore.id }}">
            <div class="fw-bold">{{ chore.title }}</div>
            <div class="text-muted small">
                {% if chore.assigned_to %}{{ chore.assigned_to }}{% endif %}
                {% if chore.priority %}{% if chore.assigned_to %} • {% endif %}{{ chore.priority|capitalize }}{% endif
                %}
            </div>
            <button class="btn btn-success btn-complete" data-complete-url="{{ url_for('complete_chore', chore_id=chore.id) }}" {% if chore.completed %}disabled{% endif %}>
                {{ 'Completed' if chore.completed else 'Mark Complete' }}
            </button>
        </div>
        {% endif %}
        {% endfor %}
        {% if not any_today.value %}
        <p class="text-muted mb-0">No chores due today.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('click', async function (e) {
        const btn = e.target.closest('.btn-complete');
        if (!btn) return;

        if (btn.disabled) return;
        const url = btn.dataset.completeUrl;
        const card = btn.closest('.chore-card');

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed: true })
            });
            if (!resp.ok) throw new Error('Request failed');

            card.classList.add('completed');
            btn.textContent = 'Completed';
            btn.disabled = true;
        } catch (err) {
            console.error(err);
            alert('Sorry, I couldn’t complete that chore. Try again.');
        }
    });
</script>
{% endblock %}