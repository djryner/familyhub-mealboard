{% extends "base.html" %}

{% block title %}Dashboard - Family Hub{% endblock %}

{% block content %}
<style>
    .meal-row {
        display: flex;
        overflow-x: auto;
        gap: 12px;
    }

    .meal-card {
        flex: 0 0 auto;
        min-width: 110px;
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        padding: .5rem .75rem;
    }

    .meal-card.today {
        border-color: #28a745;
        background: #e6ffe6;
    }

    .chore-card {
        border: 1px solid #dee2e6;
        border-radius: .5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .chore-card.completed {
        opacity: .55;
        text-decoration: line-through;
    }

    .btn-complete {
        width: 100%;
        margin-top: .75rem;
    }
</style>

<div class="section-header">
    <h1>Family Dashboard</h1>
</div>

{# Normalize "today" to an ISO yyyy-mm-dd string for comparisons #}
{% set today_iso = today if today is string else (today.strftime('%Y-%m-%d') if today else '') %}

<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">Meals This Week</h4>
    </div>
    <div class="card-body">
        {% if meals %}
        <div class="meal-row">
            {% for meal in meals[:7] %}
            <div class="meal-card {% if meal.iso == today_iso %}today{% endif %}">
                <div class="text-muted small">
                    {{ meal.dow }} {{ meal.mmdd }}
                </div>
                <div>{{ meal.meal }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">No meals planned yet.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4 class="mb-0">Today's Chores</h4>
    </div>
    <div class="card-body">
        {% set any_today = namespace(value=false) %}
        {% for chore in chores %}
        {% if chore.due_date %}
        {% if chore.due_date.strftime is defined %}
        {% set due_iso = chore.due_date.strftime('%Y-%m-%d') %}
        {% else %}
        {% set due_iso = chore.due_date[:10] %}
        {% endif %}
        {% else %}
        {% set due_iso = '' %}
        {% endif %}

        {% if due_iso == today_iso %}
        {% set any_today.value = true %}
        <div class="chore-card {% if chore.completed %}completed{% endif %}" id="chore-{{ chore.id }}">
            <div class="fw-bold">{{ chore.title }}</div>
            <div class="text-muted small">
                {% if chore.assigned_to %}{{ chore.assigned_to }}{% endif %}
                {% if chore.priority %}{% if chore.assigned_to %} • {% endif %}{{ chore.priority|capitalize }}{% endif
                %}
            </div>
            <button class="btn btn-success btn-complete" data-complete-url="{{ url_for('complete_chore', chore_id=chore.id) }}" {% if chore.completed %}disabled{% endif %}>
                {{ 'Completed' if chore.completed else 'Mark Complete' }}
            </button>
        </div>
        {% endif %}
        {% endfor %}
        {% if not any_today.value %}
        <p class="text-muted mb-0">No chores due today.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('click', async function (e) {
        const btn = e.target.closest('.btn-complete');
        if (!btn) return;

        if (btn.disabled) return;
        const url = btn.dataset.completeUrl;
        const card = btn.closest('.chore-card');

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed: true })
            });
            if (!resp.ok) throw new Error('Request failed');

            card.classList.add('completed');
            btn.textContent = 'Completed';
            btn.disabled = true;
        } catch (err) {
            console.error(err);
            alert('Sorry, I couldn’t complete that chore. Try again.');
        }
    });
</script>
{% endblock %}