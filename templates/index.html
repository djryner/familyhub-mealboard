{% extends "base.html" %}

{% block title %}Dashboard - Family Hub{% endblock %}

{% block content %}
<style>
.meal-row {
    display:flex;
    overflow-x:auto;
    gap:12px;
}
.meal-card {
    flex:0 0 auto;
    min-width:110px;
    border:1px solid #dee2e6;
    border-radius:.5rem;
    padding:.5rem .75rem;
}
.meal-card.today {
    border-color:#28a745;
    background:#e6ffe6;
}
.chore-card {
    border:1px solid #dee2e6;
    border-radius:.5rem;
    padding:1rem;
    margin-bottom:1rem;
}
.chore-card.completed {
    opacity:.55;
    text-decoration:line-through;
}
.btn-complete {
    width:100%;
    margin-top:.75rem;
}
</style>

<div class="section-header">
    <h1>Family Dashboard</h1>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">Meals This Week</h4>
    </div>
    <div class="card-body">
        {% if meals %}
        {% set today_str = today if today is string else today.strftime('%Y-%m-%d') %}
        {% set dt = __import__('datetime').datetime %}
        <div class="meal-row">
            {% for meal in meals[:7] %}
                {% set meal_dt = meal.date %}
                {% if meal_dt is string %}
                    {% set meal_dt = dt.strptime(meal_dt, '%Y-%m-%d') %}
                {% endif %}
                {% set meal_date_str = meal_dt.strftime('%Y-%m-%d') %}
                <div class="meal-card {% if meal_date_str == today_str %}today{% endif %}">
                    <div class="text-muted small">{{ meal_dt.strftime('%a') }} {{ meal_dt.strftime('%m/%d') }}</div>
                    <div>{{ meal.meal }}</div>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">No meals planned yet.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4 class="mb-0">Today's Chores</h4>
    </div>
    <div class="card-body">
        {% set today_str = today if today is string else today.strftime('%Y-%m-%d') %}
        {% set found = namespace(value=false) %}
        {% for chore in chores %}
            {% if chore.due_date %}
                {% set due_str = chore.due_date if chore.due_date is string else chore.due_date.strftime('%Y-%m-%d') %}
                {% if due_str == today_str %}
                    {% set found.value = true %}
                    <div class="chore-card {% if chore.completed %}completed{% endif %}" id="chore-{{ chore.id }}">
                        <div class="fw-bold">{{ chore.title }}</div>
                        <div class="text-muted small">
                            {% if chore.assigned_to %}{{ chore.assigned_to }} â€¢ {% endif %}{{ chore.priority.capitalize() }}
                        </div>
                        <button class="btn btn-success btn-complete" data-complete-url="{{ url_for('complete_chore', chore_id=chore.id) }}" {% if chore.completed %}disabled{% endif %}>
                            {{ 'Completed' if chore.completed else 'Mark Complete' }}
                        </button>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
        {% if not found.value %}
            <p class="text-muted mb-0">No chores due today.</p>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('click', async function(e) {
    if (e.target.classList.contains('btn-complete')) {
        const btn = e.target;
        if (btn.disabled) return;
        const url = btn.dataset.completeUrl;
        const card = btn.closest('.chore-card');
        try {
            const resp = await fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({completed: true})});
            if (resp.ok) {
                card.classList.add('completed');
                btn.textContent = 'Completed';
                btn.disabled = true;
            }
        } catch (err) {
            console.error(err);
        }
    }
});
</script>
{% endblock %}
