<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FamilyHub Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="<%= typeof theme !== 'undefined' ? theme : '' %>">
  <%- include('partials/nav', { pointsEnabled }) %>

  <main class="container">
    <%- include('partials/messages') %>

    <!-- Meals This Week - Card Layout -->
    <section class="meals-week-section">
      <div class="meals-week-cards">
        <% if (meals.length === 0) { %>
          <div class="meal-week-card empty">
            <p>No meals planned yet.</p>
          </div>
        <% } else { %>
          <% meals.forEach(meal => { %>
            <div class="meal-week-card">
              <div class="meal-day">
                <%= new Date(meal.date).toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' }) %>
              </div>
              <div class="meal-name">
                <%= meal.title %>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </section>

    <!-- Users with Their Chores -->
    <% if (usersWithChores.length === 0) { %>
      <section class="no-users">
        <p>No users found. Please add users in the admin panel.</p>
      </section>
    <% } else { %>
      <% usersWithChores.forEach(user => { %>
        <!-- User Profile & Chores Layout -->
        <section class="profile-chores-section">
          <!-- User Profile Card -->
          <div class="user-profile-card">
            <div class="profile-image-container">
              <% if (user.image_url) { %>
                <img src="<%= user.image_url %>" alt="<%= user.name %>" class="profile-image">
              <% } else { %>
                <div class="profile-image-placeholder">
                  <%= user.avatar || 'üë§' %>
                </div>
              <% } %>
            </div>
            <div class="profile-name"><%= user.name %></div>
            <% if (pointsEnabled) { %>
              <div class="profile-points">
                <span class="points-icon">‚≠ê</span>
                <span class="points-value"><%= user.balance %> pts</span>
              </div>
            <% } %>
          </div>

          <!-- Chores List for This User -->
          <div class="chores-list-container">
            <% if (user.chores.length === 0) { %>
              <div class="no-chores">
                <p>No chores due today! üéâ</p>
              </div>
            <% } else { %>
              <% user.chores.forEach(chore => { %>
                <div class="chore-row <%= chore.completed ? 'completed' : '' %> <%= chore.status === 'ignored' ? 'skipped' : '' %>">
                  <div class="chore-details">
                    <% if (chore.status === 'ignored') { %>
                      <div class="chore-title skipped-text"><%= chore.title %></div>
                    <% } else { %>
                      <div class="chore-title"><%= chore.title %></div>
                    <% } %>
                    <div class="chore-meta-info">
                      <span class="chore-due-date">üìÖ <%= new Date(chore.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' }) %></span>
                      <span class="chore-points">‚≠ê <%= chore.points %> pts</span>
                    </div>
                  </div>
                  <% if (chore.status === 'ignored') { %>
                    <div class="chore-status-badge skipped-badge">‚è≠Ô∏è Skipped</div>
                  <% } else if (!chore.completed) { %>
                    <div class="chore-buttons">
                      <form method="POST" action="/chores/<%= chore.id %>/complete" style="display: inline;">
                        <button type="submit" class="btn-chore btn-complete">‚úì Complete</button>
                      </form>
                      <form method="POST" action="/chores/<%= chore.id %>/ignore" style="display: inline;">
                        <button type="submit" class="btn-chore btn-skip">Skip</button>
                      </form>
                    </div>
                  <% } else { %>
                    <div class="chore-status-badge done-badge">‚úÖ Done</div>
                  <% } %>
                </div>
              <% }); %>
            <% } %>
          </div>
        </section>
      <% }); %>
    <% } %>

  </main>

  <%- include('partials/footer') %>

  <script>
    // Auto-refresh the dashboard every 5 minutes to show updated chores/meals
    setTimeout(function() {
      window.location.reload();
    }, 300000); // 5 minutes
  </script>
</body>
</html>
